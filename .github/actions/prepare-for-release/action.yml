name: Prepare for release

description: Builds, tests, and creates an installer that's ready for release.

inputs:
  version:
    description: 'Version number for the app'
    default: '0.0.0'
  archs:
    description: 'Architectures for the build'
    default: 'x64 arm64'

runs:
  using: "composite"
  steps:
    - uses: actions/setup-dotnet@v4

    - name: Build
      shell: bash
      run: dotnet build

    - name: Test
      shell: bash
      run: dotnet test

    - name: Publish
      shell: bash
      run: |
        dotnet tool install --global wix --version 4.0.6
        for arch in ${{ inputs.archs }}; do
          dotnet publish ./DesktopClock/DesktopClock.csproj -o "publish/$arch" -c Release --os win --arch $arch -p:Version=${{ inputs.version }}
          wix build Product.wxs -d MainExeSource="publish/$arch/DesktopClock.exe" -o "publish/$arch/DesktopClock-installer-${{ inputs.version }}-${arch}.msi"
          zip "publish/$arch/DesktopClock-portable-${{ inputs.version }}-${arch}.zip" "publish/$arch/DesktopClock.exe"
        done

    - uses: actions/upload-artifact@v4
      with:
        path: |
          publish
